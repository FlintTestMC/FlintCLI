name: Test FlintMC

on:
  push:
    branches: [ master, main ]
  pull_request:
    branches: [ master, main ]

jobs:
  test:
    runs-on: ubuntu-latest

    steps:
    - uses: actions/checkout@v4

    - name: Set up Java
      uses: actions/setup-java@v4
      with:
        distribution: 'temurin'
        java-version: '21'

    - name: Set up Rust
      uses: dtolnay/rust-toolchain@nightly
      with:
        toolchain: nightly

    - name: Cache Rust dependencies
      uses: actions/cache@v4
      with:
        path: |
          ~/.cargo/bin/
          ~/.cargo/registry/index/
          ~/.cargo/registry/cache/
          ~/.cargo/git/db/
          target/
        key: ${{ runner.os }}-cargo-${{ hashFiles('**/Cargo.lock') }}
        restore-keys: |
          ${{ runner.os }}-cargo-

    - name: Download Minecraft Server
      run: |
        mkdir -p minecraft-server
        cd minecraft-server
        # Download Paper MC 1.21.9 (latest compatible version)
        wget -O server.jar https://meta.fabricmc.net/v2/versions/loader/1.21.11/0.18.4/1.1.1/server/jar
        echo "eula=true" > eula.txt

    - name: Configure Minecraft Server
      run: |
        cd minecraft-server
        cat > server.properties << EOF
        enable-command-block=true
        gamemode=creative
        difficulty=peaceful
        spawn-protection=0
        max-players=10
        online-mode=false
        pvp=false
        server-port=25565
        view-distance=10
        simulation-distance=10
        level-type=flat
        generator-settings={"layers":[{"block":"minecraft:bedrock","height":1},{"block":"minecraft:stone","height":2},{"block":"minecraft:grass_block","height":1}],"biome":"minecraft:plains"}
        spawn-monsters=false
        spawn-animals=false
        spawn-npcs=false
        EOF

        # Create spigot.yml to disable spam filter completely
        # This prevents "disconnect.spam" kicks when running multiple commands rapidly
        cat > spigot.yml << EOF
        commands:
          spam-exclusions:
            - "/"
        EOF

    - name: Start Minecraft Server
      run: |
        cd minecraft-server
        # Start server with named pipe for console input
        mkfifo server_input
        tail -f server_input | java -Xmx2G -Xms1G -jar server.jar nogui &
        SERVER_PID=$!
        echo "SERVER_PID=$SERVER_PID" >> $GITHUB_ENV

        # Wait for server to start (look for "Done" message in logs)
        echo "Waiting for server to start..."
        timeout 120 bash -c 'until grep -q "Done" logs/latest.log 2>/dev/null; do sleep 2; done' || {
          echo "Server failed to start within 120 seconds"
          cat logs/latest.log
          exit 1
        }
        echo "Server started successfully"
        sleep 2

        # Op the bot player by writing directly to the pipe
        echo "op FlintMC_TestBot" > server_input
        echo "Sent op command for FlintMC_TestBot"
        sleep 2

    - name: Build FlintMC
      run: cargo build --release

    - name: Run FlintMC Tests
      run: |
        # Run all example tests
        cargo run --release -- example_tests/ --server localhost:25565 --recursive
      timeout-minutes: 10

    - name: Stop Minecraft Server
      if: always()
      run: |
        if [ ! -z "$SERVER_PID" ]; then
          kill $SERVER_PID || true
        fi
        pkill -f "java.*server.jar" || true

    - name: Upload Server Logs
      if: failure()
      uses: actions/upload-artifact@v4
      with:
        name: minecraft-server-logs
        path: minecraft-server/logs/
        retention-days: 7
